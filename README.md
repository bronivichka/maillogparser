# maillogparser
Тестовое задание для Газпромбанк

### Структура проекта
#### 1. Конфигурационный файл Conf.pm  
Хеш-таблица параметров
* *database* - параметры доступа к БД (используется postgresql)
* *parser* - настройки парсера
* *api* - параметры HTTP демона

#### 2. Исполняемые файлы
**2.1. Парсер parser.pl**  
Лог-файл для парсинга передается в командной строке (без флагов)  
Читает заданный лог, формирует записи для импорта в таблицу message и log  
Пропускает некоторые строки (не импортирует), например:

* *2012-02-13 14:39:30 1RwtJi-000AoQ-85 <= <> R=1RlJ2m-000J0n-Dd U=mailnull P=local S=2319*  
В такой строке нет паттерна id=(.*). При этом запись предназначается для таблицы message (флаг <=). Так как в таблице message поле id является not null и primary key, вставка такой строки невозможна. Теоретически можно вычислить id по другой, более ранней записи (если таковая есть в логе), по R=1RlJ2m-000J0n-Dd  
* *2012-02-13 14:57:59 SMTP connection from [109.70.26.4] (TCP/IP connection count = 1)*  
Здесь нет int_id (идентификатора почтового сервера)
* и подобные  

Читает и обрабатывает строки порциями (chunk), размер порции указан в конфиг-файле
Перед импортом данных в БД выполняется очистка таблиц от (возможно) импортированных туда данных ранее с теми же идентификаторами  
Для таблицы message выполняется поиск по импортируемым id  
Для таблицы log выполняется поиск по int_id и временным рамкам created

**2.2. HTTP демон api.pl**  
Самый простой демон для выполнения поиска  
Запускается демоном, пишет pid и log файлы  
Обрабатывает только POST запросы на адрес http://host:port/search

#### 3. Модули
* *Maillog::Error* - набор предопределенных ошибок и их кодов
* *Maillog::Logger* - простейший логгер с минимальным форматированием
* *Maillog::Database* - функции для работы с БД (вставка/удаление записей + поиск)
* *Maillog::Parser* - функции для выполнения парсинга лога
* *Maillog::Api* - минимальная реализация HTTP демона для обработки запросов /search
* *Maillog::Utility* - общие для проекта утилиты

#### 4. html файл для поиска search.html

### TODO
Проект демонстрационный, поэтому реализация функционала простейшая. Для развития проекта требуются многие доработки, например:  
* Логгирование по уровням (DEBUG, ERROR, INFO etc)
* Поиск с возможностью задать лимит и смещение (постраничная организация на фронте)
* Реализация более продвинутого HTTP сервера: поддержка Х одновременных запросов, выдача результата в структурированном формате (JSON, как вариант) для обработки на фронте
* Усовершенствование метода проверки корректности email адреса
* Возможность читать лог-файл на лету или по cron'у (с сохранением текущего смещения, с алгоритмом обработки случая ротации лог файла и тд)
* И многое другое

